{"componentChunkName":"component---src-templates-blog-post-js","path":"/running-microsoft-orleans-in-aws-ecs/","webpackCompilationHash":"b1bb345794198b5229c0","result":{"data":{"site":{"siteMetadata":{"title":"Coding Comrade","author":"Eugene Yamenko","siteUrl":"https://CodingComrade.com"}},"markdownRemark":{"id":"45924a14-1940-5bf3-a02a-22c2eeaae418","excerpt":"Microsoft Orleans is a great framework for building distributed systems. It runs many little silos that do their bit of work. In order to work as a one system…","html":"<p><a href=\"https://dotnet.github.io/orleans/\">Microsoft Orleans</a> is a great framework for building distributed systems. It runs many little silos that do their bit of work. In order to work as a one system, they need to talk to each other. Unfortunately, there is no documentation on how to deploy it into <a href=\"https://aws.amazon.com/ecs/\">AWS ECS</a> and one will most likely face some networking issues.</p>\n<p>In a dynamic environment, like <a href=\"https://aws.amazon.com/ecs/\">AWS ECS</a>, containers scale up and down all the time to achieve optimal resource utilisation or to respond to the load, e.g. number of messages in the processing queue. Each <a href=\"https://dotnet.github.io/orleans/\">Microsoft Orleans</a> silo registers itself in a directory during the startup stage, normally it’s a database. This is how they know how to discover each other. But how is it possible to find out the host’s IP address and port, when we don’t even know the container instance which will host the task?</p>\n<p><a href=\"https://aws.amazon.com/\">AWS</a> provides multiple HTTP endpoints that allow us to get useful information at runtime. The port information can be read from the <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-metadata-endpoint-v4.html\">Amazon ECS Task metadata endpoint version 4</a>. It returns JSON data, including the port mappings we are after. The container instance IP address can be obtained by calling the following <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html\">instance metadata</a> endpoint: <code class=\"language-text\">http://169.254.169.254/latest/meta-data/local-ipv4</code>. Now, there are no <a href=\"https://aws.amazon.com/sdk-for-net/\">AWS SDK</a> classes, which provide this functionality out of the box. I’ve created a handy <a href=\"https://www.nuget.org/packages/AWSECS.ContainerMetadata/\">NuGet package</a> that does what we need.</p>\n<ol>\n<li>Add the <a href=\"https://www.nuget.org/packages/AWSECS.ContainerMetadata/\">AWSECS.ContainerMetadata NuGet package</a> to the project:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">dotnet <span class=\"token function\">add</span> package AWSECS.ContainerMetadata</code></pre></div>\n<ol start=\"2\">\n<li>Add the AWS Container Metadata Service to the DI container:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">services<span class=\"token punctuation\">.</span><span class=\"token function\">AddAWSContainerMetadataService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ol start=\"3\">\n<li>Finally, get the information we are looking for and configure the <a href=\"https://dotnet.github.io/orleans/\">Microsoft Orleans’</a> endpoint options (assuming we exposed the default ports from within the container):</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Configure</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">EndpointOptions</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>options <span class=\"token operator\">=></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> awsContainerMetadata <span class=\"token operator\">=</span> _awsContainerMetadata<span class=\"token punctuation\">.</span><span class=\"token function\">GetContainerMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> siloPort <span class=\"token operator\">=</span> awsContainerMetadata<span class=\"token punctuation\">?.</span>Ports<span class=\"token punctuation\">?.</span><span class=\"token function\">FirstOrDefault</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">=></span> p<span class=\"token punctuation\">.</span>ContainerPort <span class=\"token operator\">==</span> EndpointOptions<span class=\"token punctuation\">.</span>DEFAULT_SILO_PORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">?.</span>HostPort <span class=\"token operator\">??</span> EndpointOptions<span class=\"token punctuation\">.</span>DEFAULT_SILO_PORT<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> gatewayPort <span class=\"token operator\">=</span> awsContainerMetadata<span class=\"token punctuation\">?.</span>Ports<span class=\"token punctuation\">?.</span><span class=\"token function\">FirstOrDefault</span><span class=\"token punctuation\">(</span>p <span class=\"token operator\">=></span> p<span class=\"token punctuation\">.</span>ContainerPort <span class=\"token operator\">==</span> EndpointOptions<span class=\"token punctuation\">.</span>DEFAULT_GATEWAY_PORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">?.</span>HostPort <span class=\"token operator\">??</span> EndpointOptions<span class=\"token punctuation\">.</span>DEFAULT_GATEWAY_PORT<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> advertisedIPAddress <span class=\"token operator\">=</span> _awsContainerMetadata<span class=\"token punctuation\">.</span><span class=\"token function\">GetHostPrivateIPv4Address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">??</span> Dns<span class=\"token punctuation\">.</span><span class=\"token function\">GetHostAddresses</span><span class=\"token punctuation\">(</span>Dns<span class=\"token punctuation\">.</span><span class=\"token function\">GetHostName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">First</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    options<span class=\"token punctuation\">.</span>AdvertisedIPAddress <span class=\"token operator\">=</span> advertisedIPAddress<span class=\"token punctuation\">;</span>\n    options<span class=\"token punctuation\">.</span>SiloPort <span class=\"token operator\">=</span> siloPort<span class=\"token punctuation\">;</span>\n    options<span class=\"token punctuation\">.</span>GatewayPort <span class=\"token operator\">=</span> gatewayPort<span class=\"token punctuation\">;</span>\n    options<span class=\"token punctuation\">.</span>GatewayListeningEndpoint <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IPEndPoint</span><span class=\"token punctuation\">(</span>IPAddress<span class=\"token punctuation\">.</span>Any<span class=\"token punctuation\">,</span> EndpointOptions<span class=\"token punctuation\">.</span>DEFAULT_GATEWAY_PORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    options<span class=\"token punctuation\">.</span>SiloListeningEndpoint <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IPEndPoint</span><span class=\"token punctuation\">(</span>IPAddress<span class=\"token punctuation\">.</span>Any<span class=\"token punctuation\">,</span> EndpointOptions<span class=\"token punctuation\">.</span>DEFAULT_SILO_PORT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><br>\nIt’s as simple as that. If you want to take a look at the source code, it’s hosted <a href=\"https://github.com/eyamenko/AWSECS.ContainerMetadata\">here</a>. If you find an issue or just want to make it better, please don’t hesitate to create a pull request.</p>\n<p>Happy coding!</p>","frontmatter":{"title":"Running Microsoft Orleans in AWS ECS","date":"October 05, 2020","description":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/running-microsoft-orleans-in-aws-ecs/","previous":{"fields":{"slug":"/robust-caching-with-redis/"},"frontmatter":{"title":"Robust caching with Redis"}},"next":{"fields":{"slug":"/using-resource-account-context-key-to-scope-down-iam-role-permissions/"},"frontmatter":{"title":"Using ResourceAccount context key to scope down IAM role permissions"}}}}}